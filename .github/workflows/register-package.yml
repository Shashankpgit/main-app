name: Debug Register Flow

on:
  workflow_dispatch:

jobs:
  register:
    runs-on: ubuntu-latest

    steps:
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Download Release Asset from function-lib
      run: |
        echo "Fetching asset URL..."
        curl -s -H "Accept: application/vnd.github+json" \
          -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
          https://api.github.com/repos/YOUR_USERNAME/function-lib/releases/latest/assets > assets.json

        cat assets.json  # Print the API response

        asset_url=$(cat assets.json | jq -r '.[] | select(.name=="dist.tar.gz") | .url')
        echo "Asset URL: $asset_url"

        curl -L -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
             -H "Accept: application/octet-stream" \
             -o dist.tar.gz "$asset_url"

    - name: List downloaded file
      run: ls -lh dist.tar.gz

    - name: Call dummy Register API
      run: |
        curl -X POST https://httpbin.org/post \
             -H "Content-Type: application/json" \
             -d '{"version": "v1.0.2", "source": "main-app"}'
